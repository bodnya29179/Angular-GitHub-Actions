name: Config

on:
  workflow_call:
    outputs:
      shared-variables:
        value: ${{ jobs.setup-config.outputs.shared-variables }}

jobs:
  setup-config:
    runs-on: ubuntu-latest

    outputs:
      shared-variables: ${{ steps.initialize-variables.outputs.value }}

    steps:
      - name: '‚òÅÔ∏è Checkout repository'
        uses: actions/checkout@v3

      - name: '‚ú® Initialize shared variables'
        id: initialize-variables
        uses: actions/github-script@v7
        env:
          NODE_VERSION: 18.18.0
          NODE_MODULES_CACHE_KEY: node-modules-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          NODE_MODULES_CACHE_RESTORE_KEY: node-modules-cache-
        with:
          script: |
            const environment = ${{ toJSON(env) }};
            
            switch('${{ github.event_name }}') {
              case 'pull_request': {
                environment.headSha = '${{ github.event.pull_request.head.sha }}';
                environment.currentBranch = '${{ github.head_ref }}';
                environment.buildCacheKey = `build-${ environment.currentBranch }-${ environment.headSha }-${{ github.run_number }}`;

                break;
              }
              case 'workflow_dispatch':
              case 'push': {
                environment.headSha = '${{ github.sha }}';
                environment.currentBranch = '${{ github.ref_name }}';
                environment.buildCacheKey = `build-${ environment.currentBranch }-${ environment.headSha }`;

                break;
              }
            }
            
            core.exportVariable('HEAD_SHA', environment.headSha);
            core.exportVariable('CURRENT_BRANCH', environment.currentBranch);
            core.exportVariable('BUILD_CACHE_KEY', environment.buildCacheKey);

            core.setOutput('value', JSON.stringify(environment));

      - name: 'üëÄ Display variables'
        uses: actions/github-script@v7
        with:
          script: |
            console.log(${{ steps.initialize-variables.outputs.value }});
